#!/bin/bash -e

# Start fcgiwrap for git-http-backend
spawn-fcgi -s /tmp/nginx/fcgiwrap.socket -U rails -G rails -P /tmp/nginx/fcgiwrap.pid -- /usr/bin/fcgiwrap

# Start puma in the background
./bin/rails server -p 3000 &
PUMA_PID=$!

# Trap SIGTERM to cleanly shut down child processes
cleanup() {
  kill "$PUMA_PID" 2>/dev/null
  [ -f /tmp/nginx/fcgiwrap.pid ] && kill "$(cat /tmp/nginx/fcgiwrap.pid)" 2>/dev/null
  wait "$PUMA_PID" 2>/dev/null
  exit 0
}
trap cleanup SIGTERM SIGINT

# Start nginx in the foreground
nginx -g 'daemon off;' &
NGINX_PID=$!

# Wait for nginx â€” if any process dies, the container stops
wait $NGINX_PID
