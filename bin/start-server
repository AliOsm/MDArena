#!/bin/bash -e

# Start fcgiwrap for git-http-backend
spawn-fcgi -s /tmp/nginx/fcgiwrap.socket -U rails -G rails -P /tmp/nginx/fcgiwrap.pid -- /usr/bin/fcgiwrap

# Start puma in the background
./bin/rails server -p 3000 &
PUMA_PID=$!

# Trap SIGTERM to cleanly shut down child processes
cleanup() {
  [ -n "${NGINX_PID:-}" ] && kill "$NGINX_PID" 2>/dev/null || true
  kill "$PUMA_PID" 2>/dev/null || true
  [ -f /tmp/nginx/fcgiwrap.pid ] && kill "$(cat /tmp/nginx/fcgiwrap.pid)" 2>/dev/null || true

  [ -n "${NGINX_PID:-}" ] && wait "$NGINX_PID" 2>/dev/null || true
  wait "$PUMA_PID" 2>/dev/null || true
}
trap 'cleanup; exit 0' SIGTERM SIGINT

# Start nginx in the background
nginx -g 'daemon off;' &
NGINX_PID=$!

# If any process dies, stop the container.
wait -n "$NGINX_PID" "$PUMA_PID"
status=$?

cleanup
exit "$status"
