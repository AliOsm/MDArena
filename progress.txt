## Codebase Patterns
- Use `@nuxt/ui` (not `@nuxt/ui-vue`) — the Vue standalone package is the same `@nuxt/ui` npm package
- Use `@rails/actioncable` (not `@actioncable/core`) for Action Cable JS client
- Yarn 4 with `nodeLinker: node-modules` in `.yarnrc.yml` for tool compatibility (PnP breaks oxlint/oxfmt)
- Always run `bundle exec rubocop -A` to auto-fix correctable offenses before committing
- The project uses `rubocop-rails-omakase` base config — it must be in the Gemfile
- oxfmt works with directory arguments (e.g. `oxfmt --check app/javascript`) when glob patterns fail
- `@codemirror/state`, `@codemirror/view`, and `typescript` are needed as peer dependencies
- Pin `vite-plugin-ruby` to `5.1.0` — v5.1.2 has a `this.meta` bug that crashes Vite
- Vite 6 required for ESM-only `@nuxt/ui/vite` import; `"type": "module"` needed in package.json
- Nuxt UI CSS import is `@import "@nuxt/ui"` (not `@nuxt/ui-vue/theme.css`)
- Auto-generated files (`auto-imports.d.ts`, `components.d.ts`) should be in `.gitignore`
- Nuxt UI Vue plugin import is `@nuxt/ui/vue-plugin` (not `@nuxt/ui/vue`) — use this in createInertiaApp setup
- Inertia page resolution glob path is relative to entrypoints dir: `../pages/**/*.vue`
- Rubocop 1.84+ uses `plugins:` instead of `require:` for loading extensions (avoids deprecation warnings)
- oxlint config (`.oxlintrc.json`) uses `rules` object with string severities and `ignorePatterns` array
- oxfmt config (`.oxfmt.json`) supports `plugins.tailwindcss` for class sorting
- mise tasks use `[tasks."name"]` TOML syntax with `run` for shell commands and `depends` for task dependencies
- Docker Compose volume for postgres should mount to `/var/lib/postgresql/data` (not `/var/lib/postgresql`)
- `mise run dev` starts Docker, installs deps, prepares DB, runs bin/dev with SIGINT/SIGTERM trap for cleanup
- database.yml uses ENV vars `DB_HOST`, `DB_USERNAME`, `DB_PASSWORD` with defaults `localhost`/`postgres`/`postgres`
- Rails 8.1.2 without Sprockets: `config.assets.quiet` causes "undefined method 'assets'" — remove it from development.rb
- Devise fixtures use `Devise::Encryptor.digest(User, 'password123')` in ERB for proper password hashing
- Include `Devise::Test::IntegrationHelpers` in `ActionDispatch::IntegrationTest` for `sign_in`/`sign_out` helpers
- Devise requires a root route — `authenticate_user!` redirects to root after sign-in; define a root before other routes
- Rubocop `Minitest/MultipleAssertions` defaults to max 3 assertions per test — use set operations to check collections in a single assertion
- `vue-router@^4.5.0` is required by `@nuxt/ui` — Link component imports `useRoute` from `vue-router`
- Devise Inertia controllers use `redirect_to ... inertia: { errors: ... }` for validation errors (not 422 responses)
- `InertiaRails.configure` uses option assignment (`config.ssr_enabled = false`), not `config.share` blocks
- `inertia_rails` v3.17 automatically shares flash `notice` and `alert` keys as top-level props (via `flash_keys` config)
- Set `config.always_include_errors_hash = true` in InertiaRails config to avoid deprecation warnings
- Vite test build (`bin/vite build --clear --mode=test`) must succeed before Inertia integration tests work
- Use `inertia_share` on controllers (not `config.shared_data`) to share data with Inertia pages — `config.shared_data` doesn't exist in inertia_rails v3.17
- Auth pages must use `defineOptions({ layout: false })` to opt out of AppLayout
- Nuxt UI v3 uses `UApp` component as root wrapper for toast/overlay support (not `UNotifications`)
- Default Inertia layout: set `page.default.layout` in resolve function; check `=== undefined` to allow pages to opt out with `layout: false`
- ERB in YAML fixtures: use `<% ... %>` (no output) for variable assignments — `<%= ... %>` outputs into YAML and breaks parsing
- `has_secure_token` requires the named column in DB — for digest-based tokens, use `SecureRandom` + `attr_reader` + `before_create` callback
- Integration tests don't raise `ActiveRecord::RecordNotFound` — Rails catches it and returns 404; use `assert_response :not_found`
- Git repos root path: `Rails.configuration.repos_root` — defaults to `tmp/repos`, overridable with `GIT_REPOS_ROOT` env var
- Rugged `Commit.create` requires Ruby `Time.now`, not ActiveSupport `Time.current` (TypeError: expected Time object)
- GitService uses `refs/heads/main` as the default branch reference for all operations
- Parallel test workers can crash with Rugged — use `PARALLEL_WORKERS=1` if segfaults occur
- File routes with `.md` extensions need glob `*path` with `format: false` + `defaults: { format: :html }` to prevent Rails from treating `.md` as request format
- Route helper convention for nested file routes: `project_file_path`, `project_edit_file_path`, `project_destroy_file_path` (not `edit_project_file_path`)
- `rescue_from GitService::FileNotFoundError` with `raise ActiveRecord::RecordNotFound` to return proper 404 responses
- CodeMirror 6: use `shallowRef` for EditorView, initialize in `onMounted`, use `v-show` (not `v-if`) to preserve editor when toggling views
- Test env must set `config.active_job.queue_adapter = :test` — GoodJobAdapter doesn't support `assert_enqueued_with` and other ActiveJob test helpers
- GoodJob dashboard: `mount GoodJob::Engine, at: "good_job"` inside `authenticate :user, ->(u) { u.admin? }` block
- Solid Cable multi-database setup: cable databases need `migrations_paths: db/cable_migrate` to avoid inheriting primary migrations; use `schema_dump: cable_schema.rb` for schema dumps
- ActionCable Connection `connect` method must be public — `respond_to?(:connect)` only checks public methods; if private, test framework skips calling it
- ActionCable connection tests: use `Struct.new(:user)` for warden mock (OpenStruct requires explicit require in Ruby 3.4)

---

## 2026-02-06 - US-002
- What was implemented: Set up JavaScript dependencies and package.json with all required packages for the frontend build pipeline
- Files changed:
  - package.json (added all dependencies, devDependencies, packageManager, scripts)
  - .yarnrc.yml (created, set nodeLinker to node-modules)
  - yarn.lock (regenerated with all new dependencies)
  - Gemfile (added rubocop-rails-omakase gem)
  - Gemfile.lock (updated)
  - app/javascript/entrypoints/application.js (formatted by oxfmt)
  - config/initializers/content_security_policy.rb (rubocop auto-fix)
- **Learnings for future iterations:**
  - PRD references `@nuxt/ui-vue` and `@actioncable/core` but these don't exist on npm; correct packages are `@nuxt/ui` and `@rails/actioncable`
  - Yarn PnP (.pnp.cjs) breaks oxlint/oxfmt — must use `nodeLinker: node-modules` in .yarnrc.yml
  - `rubocop-rails-omakase` was missing from Gemfile but referenced in .rubocop.yml — caused rubocop to crash
  - `@iconify-json/heroicons` latest is 1.2.3 (not 1.2.5) — be careful with version ranges
  - oxfmt glob patterns (e.g. `'app/javascript/**/*.{vue,js,ts}'`) are treated literally by the tool, not as shell globs; they work when matching files exist but fail with "no target file" when no files match the pattern
---

## 2026-02-06 - US-003
- What was implemented: Configured Vite with Vue, Nuxt UI, and Tailwind CSS 4 plugins
- Files changed:
  - vite.config.js (renamed from vite.config.mts; added vue(), ViteRuby(), ui() plugins with primary 'blue' and neutral 'slate'; added @ alias)
  - app/javascript/css/application.css (created; imports tailwindcss and @nuxt/ui with @source directive)
  - package.json (added "type": "module", upgraded vite to ^6.4.1, pinned vite-plugin-ruby to 5.1.0)
  - .gitignore (added auto-imports.d.ts and components.d.ts)
  - yarn.lock (updated)
- **Learnings for future iterations:**
  - `vite-plugin-ruby` v5.1.2 has a `this.meta` bug in the `config` hook — crashes with "Cannot read properties of undefined (reading 'meta')". Pin to 5.1.0.
  - `@nuxt/ui/vite` is ESM-only — requires `"type": "module"` in package.json or `.mjs` extension
  - Vite 5 doesn't work well with ESM-only plugins in `.js` config files — upgraded to Vite 6
  - The correct CSS import for Nuxt UI standalone is `@import "@nuxt/ui"`, not `@nuxt/ui-vue/theme.css`
  - Nuxt UI vite plugin auto-generates `auto-imports.d.ts` and `components.d.ts` — add to `.gitignore`
  - `vite build` and `vite dev` fail when run directly via node CLI due to `vite-plugin-ruby` needing Rails context; use `bin/vite dev` or verify config loads via Vite's `loadConfigFromFile` API
---

## 2026-02-06 - US-004
- What was implemented: Set up Inertia.js app entry point with createInertiaApp(), Vue 3, and Nuxt UI Vue plugin
- Files changed:
  - app/javascript/entrypoints/application.js (replaced placeholder with full Inertia.js + Nuxt UI setup)
- **Learnings for future iterations:**
  - Nuxt UI Vue plugin import path is `@nuxt/ui/vue-plugin` — confirmed from official Nuxt UI docs for standalone Vue + Inertia setup
  - Page resolution glob path must be relative to the entrypoints directory: `../pages/**/*.vue`
  - Inertia plugin is `.use(plugin)` (from setup params), Nuxt UI is `.use(ui)` — both registered on the same createApp chain
  - oxfmt prefers double quotes over single quotes for JS string literals
---

## 2026-02-06 - US-005
- What was implemented: Configured Rubocop linting with rubocop-rails, rubocop-minitest, rubocop-performance plugins and project-specific rules
- Files changed:
  - .rubocop.yml (replaced placeholder config with full configuration)
- **Learnings for future iterations:**
  - Rubocop 1.84+ uses `plugins` instead of `require` for extensions — using `require` still works but emits deprecation warnings
  - The `rubocop-rails-omakase` base config is inherited; our project-specific rules override/extend it
  - All 22 files in the scaffolded codebase pass rubocop with zero offenses out of the box
---

## 2026-02-06 - US-006
- What was implemented: Configured Oxlint and oxfmt for JavaScript/Vue linting and formatting
- Files changed:
  - .oxlintrc.json (created with rules: no-unused-vars warn, no-console warn, eqeqeq error; ignorePatterns for node_modules, public, tmp)
  - .oxfmt.json (created with printWidth 100, semi false, singleQuote true, trailingComma all, tailwindcss plugin)
  - package.json (updated format/format:check scripts to use directory args instead of glob patterns)
- **Learnings for future iterations:**
  - oxfmt glob patterns with brace expansion (e.g. `'app/javascript/**/*.{vue,js,ts}'`) fail with "no target file" — use directory arguments instead (e.g. `app/javascript`)
  - oxlint uses a `rules` object in `.oxlintrc.json` with string severity values: "warn", "error", "off"
  - oxfmt tailwindcss plugin config goes under `plugins.tailwindcss` with `classAttributes` and `functions` arrays
---

## 2026-02-06 - US-007
- What was implemented: Configured mise tasks, Docker Compose for development, and Procfile.dev
- Files changed:
  - .mise.toml (created; node 25.2.1, ruby 3.4.7, yarn 4.12.0; tasks: docker:start, docker:stop, deps, deps:ruby, deps:js, db:prepare, lint, test, dev)
  - dev-docker-compose.yml (updated; postgres:18-alpine with healthcheck, browserless/chrome on 3333:3000, pgdata volume)
  - Procfile.dev (updated; changed js to yarn vite dev, added jobs: bundle exec good_job start)
- **Learnings for future iterations:**
  - mise TOML task definitions use `[tasks."task:name"]` with `run` for commands and `depends` for dependencies
  - Docker postgres volume should mount to `/var/lib/postgresql/data` (with `/data` suffix) for proper persistence
  - `mise tasks` command validates that all tasks are correctly parsed
  - The `dev` task uses a shell trap to clean up Docker containers on SIGINT/SIGTERM
  - Procfile.dev uses `yarn vite dev` (not `bin/vite dev`) consistent with the yarn-based JS toolchain
---

## 2026-02-06 - US-008
- What was implemented: Created users and personal_access_tokens migrations with all required columns, constraints, and indexes
- Files changed:
  - db/migrate/20260206144925_create_users.rb (users table: name, email, encrypted_password not null; admin default false; unique index on email)
  - db/migrate/20260206144946_create_personal_access_tokens.rb (PAT table: user_id FK not null, name not null, token_digest not null unique, token_prefix limit 8, last_used_at, expires_at, revoked_at)
  - db/schema.rb (auto-generated from migrations)
  - config/database.yml (added host/username/password with ENV defaults for Docker postgres)
  - config/environments/development.rb (removed config.assets.quiet — Sprockets not available)
- **Learnings for future iterations:**
  - Rails 8.1.2 scaffolded app includes `config.assets.quiet` in development.rb but Sprockets is not included — causes "undefined method 'assets'" error. Must remove this line.
  - PostgreSQL via Docker Compose uses `postgres`/`postgres` credentials — database.yml needs explicit host/username/password when not using unix sockets
  - Rollback/re-migrate idempotency verified — use `create_table` and `add_index` in `change` method for automatic reversibility
---

## 2026-02-06 - US-009
- What was implemented: Created projects and project_memberships migrations with all required columns, constraints, indexes, and foreign keys
- Files changed:
  - db/migrate/20260206145228_create_projects.rb (projects table: name, slug, uuid with gen_random_uuid(), owner_id FK to users; unique indexes on slug and uuid)
  - db/migrate/20260206145244_create_project_memberships.rb (project_memberships table: user_id FK, project_id FK, role default 'editor'; unique composite index on [user_id, project_id])
  - db/schema.rb (auto-generated)
- **Learnings for future iterations:**
  - `t.uuid :uuid, null: false, default: "gen_random_uuid()"` — Rails handles the string-to-proc conversion for PostgreSQL UUID defaults
  - `t.references :owner, null: false, foreign_key: { to_table: :users }` — use `to_table` option when the FK column name doesn't match the target table name
  - Postgres port 5432 may already be allocated from a previous Docker start — check before starting containers
---

## 2026-02-06 - US-010
- What was implemented: Created documents migration for caching file metadata with project_id FK, path, last_commit_sha, last_modified_at, and unique composite index
- Files changed:
  - db/migrate/20260206145428_create_documents.rb (documents table: project_id FK not null, path not null, last_commit_sha, last_modified_at; unique composite index on [project_id, path])
  - db/schema.rb (auto-generated)
- **Learnings for future iterations:**
  - Port 5432 may be occupied by an SSH tunnel rather than Docker — the database is still accessible, just skip Docker container start
  - Simple migrations with `create_table` + `add_index` in `change` method are automatically reversible without explicit `up`/`down`
---

## 2026-02-06 - US-011
- What was implemented: Set up Devise authentication backend with User model, routes, controller auth, and tests
- Files changed:
  - app/models/user.rb (created; Devise modules: database_authenticatable, registerable, recoverable, rememberable, validatable; name presence validation)
  - app/controllers/application_controller.rb (added before_action :authenticate_user!, configure_permitted_parameters for :name)
  - app/controllers/home_controller.rb (created; temporary root controller rendering head :ok)
  - config/initializers/devise.rb (generated by Devise installer)
  - config/locales/devise.en.yml (generated by Devise installer)
  - config/routes.rb (added devise_for :users, DELETE /logout route, root "home#index")
  - db/migrate/20260206145752_add_devise_columns_to_users.rb (adds reset_password_token, reset_password_sent_at, remember_created_at, unique index)
  - db/schema.rb (auto-generated)
  - test/test_helper.rb (added Devise::Test::IntegrationHelpers)
  - test/fixtures/users.yml (alice, bob, admin fixtures with encrypted passwords)
  - test/models/user_test.rb (7 tests: validations, Devise modules)
  - test/integration/authentication_test.rb (8 tests: redirect, login, logout, signup, invalid credentials)
- **Learnings for future iterations:**
  - Devise needs a root route — after sign-in it redirects to root_path; without it tests get 404
  - Use `Devise::Encryptor.digest(User, 'password123')` in fixture ERB for password hashing
  - `Devise::Test::IntegrationHelpers` must be included in `ActionDispatch::IntegrationTest` for `sign_in`/`sign_out` helpers
  - Devise `configure_permitted_parameters` must be set up for custom attributes like `:name` — otherwise sign-up silently ignores them
  - Rubocop auto-fix (`-A`) handles most Minitest assertion style changes (e.g., `assert_predicate`, `assert_includes`, empty lines before assertions)
---

## 2026-02-06 - US-012
- What was implemented: Created Devise Inertia auth pages for login, signup, and logout flows
- Files changed:
  - app/controllers/users/sessions_controller.rb (created; overrides Devise SessionsController to render Inertia pages, handle auth with warden.authenticate non-bang)
  - app/controllers/users/registrations_controller.rb (created; overrides Devise RegistrationsController to render Inertia pages, redirect with validation errors)
  - app/javascript/pages/Auth/SignIn.vue (created; login page with UInput, UFormField, UButton, router.post submission)
  - app/javascript/pages/Auth/SignUp.vue (created; signup page with name/email/password/confirmation fields, router.post submission)
  - config/initializers/inertia_rails.rb (created; InertiaRails config with ssr_enabled: false, always_include_errors_hash: true)
  - config/routes.rb (updated devise_for to use custom controllers, updated logout route)
  - package.json (added vue-router dependency)
  - yarn.lock (updated)
  - test/integration/authentication_test.rb (updated: invalid credentials now expect redirect instead of 422)
- **Learnings for future iterations:**
  - `@nuxt/ui` requires `vue-router@^4.5.0` as a peer dependency — its Link component imports `useRoute` from `vue-router`, and Vite build fails without it
  - Devise Inertia pattern: use `warden.authenticate` (non-bang) in sessions#create to avoid the failure app recall mechanism; manually redirect with `inertia: { errors: ... }` on failure
  - `redirect_to path, inertia: { errors: hash }` stores errors in `session[:inertia_errors]` which are automatically merged into the next Inertia page's props as `errors`
  - `InertiaRails.configure` in v3.17 uses direct option assignment, not method-based DSL (no `config.share`, use `config.ssr_enabled = false`)
  - Flash keys `[:notice, :alert]` are shared as top-level props by default — no need for manual flash sharing
  - `config.always_include_errors_hash = true` suppresses deprecation warning and ensures `errors: {}` is always in props
  - Vite test build must be run (`bin/vite build --clear --mode=test`) before Inertia integration tests that render pages can work
---

## 2026-02-06 - US-013
- What was implemented: Created AppLayout with navigation header, shared currentUser via inertia_share, updated page resolution to use default layout
- Files changed:
  - app/javascript/layouts/AppLayout.vue (created; header with MarkdownForge link, user name, Tokens/Settings/Logout buttons; UApp wrapper for toasts; UContainer for content; dark mode support)
  - app/javascript/entrypoints/application.js (updated resolve to set AppLayout as default layout)
  - app/javascript/pages/Auth/SignIn.vue (added defineOptions({ layout: false }) to opt out of AppLayout)
  - app/javascript/pages/Auth/SignUp.vue (added defineOptions({ layout: false }) to opt out of AppLayout)
  - app/controllers/application_controller.rb (added inertia_share for currentUser data)
  - app/controllers/home_controller.rb (changed from head :ok to render inertia: "Home")
  - app/javascript/pages/Home.vue (created; simple welcome page placeholder)
- **Learnings for future iterations:**
  - `inertia_share` is a class-level method on controllers, not a config option — `config.shared_data=` does not exist in inertia_rails v3.17
  - Nuxt UI v3 uses `UApp` as root wrapper component for toast/tooltip/overlay support — there is no `UNotifications` component
  - Auth pages need `defineOptions({ layout: false })` to skip the default AppLayout (they have their own full-screen centered layout)
  - Inertia layout resolution: check `page.default.layout === undefined` (not falsy) to allow pages to explicitly set `layout: false`
  - unplugin-vue-components auto-registers UApp, UContainer, UButton on first use in templates — no manual import needed
---

## 2026-02-06 - US-014
- What was implemented: Built PersonalAccessToken model with SHA-256 token digest, active scope, authenticate class method, and revoke! instance method
- Files changed:
  - app/models/personal_access_token.rb (created; belongs_to :user, attr_reader :token, before_create generates token/digest/prefix, active scope, self.authenticate, revoke!)
  - app/models/user.rb (added has_many :personal_access_tokens, dependent: :destroy)
  - test/fixtures/personal_access_tokens.yml (created; active_token, revoked_token, expired_token fixtures)
  - test/models/personal_access_token_test.rb (created; 8 tests covering creation, authentication, revoke, expiry, active scope)
- **Learnings for future iterations:**
  - `has_secure_token :token` requires a `token` column in the DB — since we store `token_digest` instead, use `SecureRandom.base58(24)` with `attr_reader :token` and set `@token` in before_create callback
  - ERB in YAML fixtures: use `<% ... %>` (no output) for variable assignments, `<%= ... %>` only for values — output ERB tags on their own line break YAML parsing
  - Rubocop `Minitest/MultipleAssertions` defaults to max 3 assertions per test — split tests that verify multiple aspects
---

## 2026-02-06 - US-015
- What was implemented: Token management controller with index, create, and destroy (revoke) actions under /settings/tokens namespace
- Files changed:
  - app/controllers/settings/tokens_controller.rb (created; Settings::TokensController with index/create/destroy, serialized token props, flash-based new token display)
  - config/routes.rb (added namespace :settings with resources :tokens)
  - test/controllers/settings/tokens_controller_test.rb (created; 6 tests: index, create, destroy, cross-user guard, auth guard)
- **Learnings for future iterations:**
  - Integration tests don't raise `ActiveRecord::RecordNotFound` directly — Rails returns a 404 response instead; use `assert_response :not_found` rather than `assert_raises`
  - `namespace :settings` creates `/settings/tokens` routes and expects controller in `Settings::TokensController` — matches the directory structure `app/controllers/settings/`
  - Flash data (`flash[:new_token]`) works well for one-time token display; Inertia shares it via `newToken` prop
---

## 2026-02-06 - US-016
- What was implemented: Token management UI page (Settings/Tokens.vue) with full CRUD UI for personal access tokens
- Files changed:
  - app/javascript/pages/Settings/Tokens.vue (created; UTable with columns for Name, Token prefix, Last Used, Status badge, Revoke action; UModal for token creation; UAlert for new token display and empty state; useToast for revoke notifications)
- **Learnings for future iterations:**
  - Nuxt UI v3 UTable uses `columns` array with `key`/`label` props and `#<column-key>-cell` slot pattern for custom cell rendering (e.g. `#name-cell`, `#status-cell`)
  - UModal uses `v-model:open` for controlling visibility and `#content` slot for modal body content
  - `useToast()` is auto-imported by Nuxt UI — call `toast.add({ title: '...', color: 'success' })` to show notifications
  - UBadge supports `color` (success, error, warning) and `variant` (subtle, solid) props for status indicators
  - UAlert supports `color`, `icon`, `title`, `description` props — good for both warning banners and empty states
  - Token status can be derived client-side from `revokedAt` and `expiresAt` fields — no need for server-side status field
---

## 2026-02-06 - US-017
- What was implemented: Project and ProjectMembership models with all associations and validations
- Files changed:
  - app/models/project.rb (created; belongs_to :owner, has_many :memberships/:users through, validates name/slug)
  - app/models/project_membership.rb (created; belongs_to :user/:project, validates role inclusion and user uniqueness scoped to project)
  - app/models/user.rb (added has_many :owned_projects, :memberships, :projects through memberships)
  - test/fixtures/projects.yml (created; alpha and beta project fixtures)
  - test/fixtures/project_memberships.yml (created; alice owner of alpha, bob editor of alpha, bob owner of beta)
  - test/models/project_test.rb (created; 8 tests for validations, associations, cascade delete)
  - test/models/project_membership_test.rb (created; 7 tests for validations, role inclusion, uniqueness, associations)
  - test/models/user_test.rb (added 3 tests for owned_projects, projects through memberships, memberships count)
- **Learnings for future iterations:**
  - DB tables for projects and project_memberships were already created in US-009 — only models/tests needed
  - Use `inverse_of: :owner` on `has_many :owned_projects` when foreign_key doesn't match convention
  - Fixtures use simple association references (e.g., `owner: alice`) — Rails resolves them automatically from the fixture name
---

## 2026-02-06 - US-018
- What was implemented: Configured repos_root for Git repository storage path
- Files changed:
  - config/application.rb (added config.repos_root from ENV['GIT_REPOS_ROOT'] with default tmp/repos)
  - .gitignore (added tmp/repos/)
- **Learnings for future iterations:**
  - `config.repos_root` is accessed via `Rails.configuration.repos_root` in service classes
  - Use `ENV.fetch("KEY", default)` pattern for env-based config with sensible defaults
  - Production uses `/var/repos` (set via Kamal env), development uses `tmp/repos`
---

## 2026-02-06 - US-019
- What was implemented: GitService class with core methods for Git repository management using Rugged
- Files changed:
  - app/services/git_service.rb (created; class with REPOS_ROOT, repo_path, init_repo, with_repo_lock, read_file, commit_file, list_files, resolve_commit; custom errors StaleCommitError, FileNotFoundError)
  - test/services/git_service_test.rb (created; 12 tests covering init, commit, read, list, stale commit detection, file lock, error cases)
- **Learnings for future iterations:**
  - Rugged `Commit.create` requires a Ruby `Time.now` object — `Time.current` (ActiveSupport::TimeWithZone) raises `TypeError: expected Time object`
  - GitService uses `refs/heads/main` as the default branch reference; Rugged bare repos don't have HEAD pointing to main by default
  - `Rugged::Index.new` creates an in-memory index; call `read_tree` on existing tree before modifying, then `write_tree(repo)` to persist
  - `Rugged::TreeError` is raised when `tree.path(path)` can't find a file — catch it for FileNotFoundError
  - `Rugged::ReferenceError` is raised when accessing HEAD on an empty repo (no commits yet)
  - Parallel test execution can cause segfaults with Rugged — run with `PARALLEL_WORKERS=1` if crashes occur
- Project routes use `param: :slug` — access via `params[:slug]`; scope to `current_user.projects.find_by!(slug:)` for member-only access
  - File locking via `File.flock(File::LOCK_EX)` on a `.lock` file provides exclusive access for concurrent write protection
  - `Rugged::Walker` with `SORT_TOPO | SORT_DATE` walks commits in topological+date order — use `push(oid)` to start from HEAD
  - Filter file history by comparing blob OID at path between commit and parent — handles both creation (parent has nil OID) and modification
---

## 2026-02-06 - US-020
- What was implemented: GitService history and delete methods — file_history, delete_file, file_content_at
- Files changed:
  - app/services/git_service.rb (added file_history, delete_file, file_content_at, blob_oid_at helper)
  - test/services/git_service_test.rb (added 9 tests: delete file, delete missing file, delete from empty repo, file history with filtering, history entry structure, history on empty repo, content at specific SHA, missing file at SHA, invalid SHA)
- **Learnings for future iterations:**
  - `Rugged::Walker` is the correct way to walk commit history — use `push(oid)` to start and `sorting(SORT_TOPO | SORT_DATE)` for proper ordering
  - To filter commits that touched a specific file: compare the blob OID at the path between the commit and its first parent — if different (or parent doesn't have the file), the commit touched it
  - `blob_oid_at` helper catches `Rugged::TreeError` and returns nil for files not present in a tree — useful for history filtering
  - `Rugged::OdbError` is raised when looking up a nonexistent SHA — catch it alongside `Rugged::InvalidError` for robust error handling
  - Rubocop `Minitest/MultipleAssertions` max is 3 — compare hashes in a single assertion instead of asserting individual fields
---

## 2026-02-06 - US-021
- What was implemented: ProjectsController with index, show, and create actions for project management
- Files changed:
  - app/controllers/projects_controller.rb (created; index with user's projects, show with files from GitService, create with slug/git repo/membership setup)
  - config/routes.rb (added resources :projects with index/create and show via member route with slug param)
  - test/controllers/projects_controller_test.rb (created; 8 tests: index, member scoping, show, 404 for non-member, create + redirect, create attributes/git repo, blank name, auth guard)
  - prd.json (marked US-021 as passes: true)
- **Learnings for future iterations:**
  - `resources :projects, param: :slug` with `member { get "/", action: :show }` generates clean routes: GET /projects/:slug maps to show, with `params[:slug]`
  - `current_user.projects.find_by!(slug: params[:slug])` scopes project access to the current user's memberships — raises RecordNotFound (404) for non-members
  - `assert_difference(["Project.count", "ProjectMembership.count"], 1)` checks multiple counters in one assertion — keeps within Minitest/MultipleAssertions max of 3
  - Compare hashes in a single assertion to verify multiple attributes without exceeding assertion limits: `assert_equal({ key1: val1, key2: val2 }, { key1: actual1, key2: actual2 })`
---

## 2026-02-06 - US-022
- What was implemented: Projects index page UI with project cards grid, create modal, and empty state
- Files changed:
  - app/javascript/pages/Projects/Index.vue (created; UCard grid with hover:ring-2 transition, role UBadge, owner name, updated_at; UAlert empty state with folder-plus icon; UModal for project creation with UFormField + UInput; router.post submission)
  - prd.json (marked US-022 as passes: true)
- **Learnings for future iterations:**
  - UCard component renders clickable project cards — use `@click` with `router.visit()` for Inertia navigation
  - Grid layout with `sm:grid-cols-2 lg:grid-cols-3` provides responsive card layout
  - Follow same modal/form pattern from Tokens.vue: ref for modal open state, ref for form value, ref for loading state, `onFinish` callback to reset
---

## 2026-02-06 - US-023
- What was implemented: Project show page UI with file list, file creation modal, and minimal FilesController#create
- Files changed:
  - app/javascript/pages/Projects/Show.vue (created; project name h1, role UBadge, clone URL code tag, file list as UButton ghost/block, empty state UAlert, UModal for file creation with auto .md extension)
  - app/controllers/files_controller.rb (created; minimal create action with set_project scoped to current_user, auto-appends .md, commits via GitService)
  - config/routes.rb (added nested files resource under projects for POST /projects/:project_slug/files)
  - test/controllers/files_controller_test.rb (created; 3 tests: create + redirect, auto .md extension, auth guard)
  - prd.json (marked US-023 as passes: true)
- **Learnings for future iterations:**
  - Nested routes: `resources :files, only: [:create], param: :path` inside projects block generates `project_files_path(project_slug)` helper
  - FilesController uses `params[:project_slug]` (not `params[:slug]`) because it's a nested resource — the parent param is prefixed
  - UButton with `block` and `class="justify-start"` creates full-width left-aligned file list items
  - File creation modal follows same pattern as project creation: ref for modal state, form submission via router.post, onFinish to reset state
---

## 2026-02-06 - US-024
- What was implemented: FilesController with full CRUD actions (show, edit, update, create, destroy) plus download_md and download_pdf actions
- Files changed:
  - app/controllers/files_controller.rb (expanded from create-only to full CRUD + download actions; added rescue_from FileNotFoundError, head_sha_for helper, serialize_project helper)
  - config/routes.rb (added glob file routes with format: false + defaults: { format: :html } for .md extension support)
  - app/jobs/pdf_export_job.rb (created; placeholder job for US-043 to allow enqueue from download_pdf action)
  - test/controllers/files_controller_test.rb (expanded from 3 to 12 tests: show, show 404, non-member 404, edit, update, stale commit, create, auto .md, destroy, download_md, download_pdf enqueue, auth guard)
  - prd.json (marked US-024 as passes: true)
- **Learnings for future iterations:**
  - Rails glob routes (`*path`) with `.md` file extensions: use `format: false` to prevent format extraction AND `defaults: { format: :html }` to set proper request format — otherwise Rails infers `:md` format and fails to find templates
  - Route helpers for `scope` with `as: :project` follow `project_<action>_file_path` pattern (not `<action>_project_file_path`) — different from `resources` naming convention
  - `rescue_from GitService::FileNotFoundError` should re-raise as `ActiveRecord::RecordNotFound` to use Rails' built-in 404 handling
  - Place more-specific glob routes (e.g., `*path/edit`, `*path/download_md`) BEFORE the catch-all `*path` route — Rails matches first-wins for glob routes
  - `send_data` with `disposition: :attachment` triggers browser download; the test can verify `Content-Disposition` header contains "attachment"
---

## 2026-02-06 - US-025
- What was implemented: MarkdownPreview Vue component for rendering Markdown content
- Files changed:
  - app/javascript/components/MarkdownPreview.vue (created; accepts content prop, renders via markdown-it with v-html, Tailwind prose classes)
- **Learnings for future iterations:**
  - markdown-it instance can be created at module level (outside setup) since it's stateless — but keeping it in `<script setup>` is fine for simplicity
  - Tailwind `prose` classes from `@tailwindcss/typography` handle headings, lists, code blocks, links, blockquotes, and tables out of the box
  - `dark:prose-invert` handles dark mode for prose content automatically
  - Component uses `v-html` directive for rendered HTML — markdown-it `html: false` ensures user HTML is escaped for safety
---

## 2026-02-06 - US-026
- What was implemented: File show page UI (Files/Show.vue) with markdown preview and action buttons
- Files changed:
  - app/javascript/pages/Files/Show.vue (created; file path heading, breadcrumb to project, MarkdownPreview component, Edit/History/Download MD/Download PDF buttons)
  - prd.json (marked US-026 as passes: true)
- **Learnings for future iterations:**
  - UButton with `tag="a"` and `:href` renders a plain anchor element for direct download links (no Inertia navigation)
  - `useToast()` is auto-imported by Nuxt UI unplugin — no explicit import needed in `<script setup>`
  - Download PDF uses `router.post` with `preserveScroll: true` to avoid page jump, then shows success toast on `onSuccess` callback
  - Route pattern for file actions: `/projects/${project.slug}/files/${path}/<action>` — matches the glob route definitions in routes.rb
---

## 2026-02-06 - US-027
- What was implemented: Markdown editor page with CodeMirror 6 (Files/Edit.vue)
- Files changed:
  - app/javascript/pages/Files/Edit.vue (created; CodeMirror 6 editor with basicSetup + markdown(), Save button with Inertia PATCH, connection status badge, toggle preview)
  - prd.json (marked US-027 as passes: true)
- **Learnings for future iterations:**
  - CodeMirror 6 must be initialized in `onMounted` — the DOM ref isn't available during setup
  - Use `shallowRef` for EditorView (not `ref`) to avoid Vue reactivity proxy wrapping the complex CM object
  - `EditorView.updateListener.of()` is the CM6 way to listen for doc changes — fires on every transaction
  - `v-show` is better than `v-if` for toggling editor/preview — `v-if` would destroy and recreate the CM editor
  - CM editor styling: use `[&_.cm-editor]` Tailwind arbitrary selector to target the inner editor element for min-height/outline
  - `router.patch` requires the content as a plain object param, not FormData — Inertia handles serialization
---

## 2026-02-06 - US-028
- What was implemented: FileHistoryController with index and show actions for viewing file commit history and file content at specific commits
- Files changed:
  - app/controllers/file_history_controller.rb (created; index renders Files/History with history array, show renders Files/HistoryShow with content at SHA)
  - config/routes.rb (added file history routes: GET .../files/:path/history and GET .../files/:path/history/:sha)
  - test/controllers/file_history_controller_test.rb (created; 7 tests: index, multiple commits, non-member 404, show at SHA, invalid SHA 404, file at commit, auth guard)
- **Learnings for future iterations:**
  - History routes must be placed BEFORE the catch-all `files/*path` route in the glob scope — Rails matches first-wins
  - FileHistoryController follows same pattern as FilesController: set_project scoped to current_user.projects, rescue_from FileNotFoundError
  - Time serialization: use `.iso8601` on Ruby Time objects for consistent JSON format in Inertia props
  - Route helpers: `project_file_history_path(slug, path)` and `project_file_history_show_path(slug, path, sha)`
---

## 2026-02-06 - US-029
- What was implemented: File history UI page (Files/History.vue) with UTable for commit history display
- Files changed:
  - app/javascript/pages/Files/History.vue (created; UTable with Commit SHA in UBadge, Message, Author, Date columns, View action button; empty state UAlert; breadcrumb navigation; Back to file button)
  - prd.json (marked US-029 as passes: true)
- **Learnings for future iterations:**
  - UTable follows the same `columns` + `#<key>-cell` slot pattern used in Tokens.vue — reuse this pattern for all table pages
  - History entries from the backend have `author` as a nested object with `name` and `email` — access via `row.author.name`
  - Breadcrumb pattern: chain UButton (variant="link") elements with `/` separators for file navigation hierarchy
  - `row.sha.slice(0, 8)` provides the standard short SHA display in a UBadge with code tag
---

## 2026-02-06 - US-030
- What was implemented: Historical file view page (Files/HistoryShow.vue) for viewing file content at a specific commit
- Files changed:
  - app/javascript/pages/Files/HistoryShow.vue (created; commit SHA in UBadge, MarkdownPreview component, Back to history button, breadcrumb navigation)
  - prd.json (marked US-030 as passes: true)
- **Learnings for future iterations:**
  - HistoryShow page follows the same layout pattern as Files/Show.vue — breadcrumb nav, heading, content in bordered card
  - The backend (FileHistoryController#show) already existed from US-028 — only the Vue page was needed
  - Reuse MarkdownPreview component for any page that renders markdown content — consistent rendering across show, edit preview, and history views
---

## 2026-02-06 - US-031
- What was implemented: Configured GoodJob as Active Job backend with async execution, queue configuration, cron jobs, and admin dashboard
- Files changed:
  - config/application.rb (added config.active_job.queue_adapter = :good_job)
  - config/initializers/good_job.rb (created; execution_mode: :async, queues, max_threads, poll_interval, shutdown_timeout, enable_cron, cron entries for cleanup_expired_tokens and cleanup_stale_ydocs)
  - config/routes.rb (added GoodJob::Engine mount at /good_job behind admin auth)
  - config/environments/test.rb (added config.active_job.queue_adapter = :test for test assertions)
  - app/jobs/cleanup_expired_tokens_job.rb (created; placeholder for US-045)
  - app/jobs/cleanup_stale_ydocs_job.rb (created; placeholder for US-046)
  - test/jobs/good_job_configuration_test.rb (created; 3 tests: adapter config, job enqueue, pdf queue name)
  - prd.json (marked US-031 as passes: true)
- **Learnings for future iterations:**
  - Test environment must override `config.active_job.queue_adapter = :test` to use `assert_enqueued_with` and other ActiveJob test helpers — GoodJobAdapter doesn't support them
  - GoodJob dashboard is mounted via `mount GoodJob::Engine, at: "good_job"` inside an `authenticate :user` block with a lambda for admin check
  - GoodJob cron config uses string class names (e.g., `"CleanupExpiredTokensJob"`) — the class must exist at boot time
  - Placeholder jobs must be created for cron entries even if implementation comes later — otherwise GoodJob will fail to schedule them
---

## 2026-02-06 - US-032
- What was implemented: Configured Action Cable with Solid Cable (PostgreSQL-backed) adapter for development and production, with authenticated WebSocket connections
- Files changed:
  - config/cable.yml (updated; solid_cable adapter for development and production, test adapter for test)
  - config/database.yml (updated; multi-database setup with cable databases for dev/test/prod; migrations_paths and schema_dump configured)
  - app/channels/application_cable/connection.rb (created; authenticates user from Devise warden session, rejects unauthenticated connections)
  - app/channels/application_cable/channel.rb (created; base channel class)
  - db/cable_migrate/.keep (created; empty migrations directory to isolate cable DB from primary migrations)
  - test/channels/connection_test.rb (created; 2 tests: authenticated connect, unauthenticated rejection)
  - prd.json (marked US-032 as passes: true)
- **Learnings for future iterations:**
  - Solid Cable uses `db/cable_schema.rb` for table setup — `db:create` auto-loads this schema, so separate migrations aren't needed for the cable table
  - Multi-database cable setup needs `migrations_paths: db/cable_migrate` to prevent primary migrations from being applied to the cable database
  - `schema_dump: cable_schema.rb` tells Rails to dump/load the cable schema to/from the correct file (path is relative to db/)
  - ActionCable Connection's `connect` method must be public — the test framework checks `respond_to?(:connect)` which only matches public methods; if private, it silently skips calling connect
  - Ruby 3.4 requires explicit `require "ostruct"` for OpenStruct — use `Struct.new(:user)` instead for warden mocking in connection tests
  - When switching from flat to multi-db database.yml, test databases need `db:prepare` to re-initialize
- Ruby 3.4: ActionCable `transmit` requires explicit hash `transmit({key: val})` — passing `transmit(key: val)` treats it as keyword args and raises `ArgumentError: wrong number of arguments`
- y-rb API: `Y::Doc.new`, `doc.get_text('name')`, `text.insert(0, str)`, `doc.full_diff` returns Array of bytes, `doc.sync(bytes_array)` applies state; pack/unpack with `"C*"` for Base64 encoding
- Test env cache: changed from `:null_store` to `:memory_store` — `:null_store` silently discards all cache reads/writes, breaking any feature that relies on `Rails.cache`
---

## 2026-02-06 - US-033
- What was implemented: DocumentChannel with subscribe logic that loads/initializes Y.js document state and transmits to client
- Files changed:
  - app/channels/document_channel.rb (created; subscribes with project_id/file_path, rejects non-members, loads/inits Y.js state from cache or Git, transmits Base64-encoded sync message, streams from document:<project_id>:<file_path>)
  - config/environments/test.rb (changed cache_store from :null_store to :memory_store for cache operations in tests)
  - test/channels/document_channel_test.rb (created; 7 tests: subscribe success, reject non-member, reject invalid project, transmit sync state, empty ydoc for missing file, cache with TTL, cached state on subsequent subscriptions)
  - prd.json (marked US-033 as passes: true)
- **Learnings for future iterations:**
  - ActionCable `transmit` method signature is `transmit(data, via:)` — the first arg is positional. In Ruby 3.4, passing `transmit(type: "sync", state: encoded)` is treated as keyword args and raises ArgumentError. Must use `transmit({type: "sync", state: encoded})` with explicit hash.
  - y-rb gem API: `doc.full_diff` returns an Array of byte integers, `doc.sync(byte_array)` applies state. Use `.pack("C*")` / `.unpack("C*")` for Base64 encoding/decoding.
  - Test env `:null_store` cache silently discards writes — switch to `:memory_store` when features depend on `Rails.cache.read`/`write`
  - Channel test pattern: `stub_connection current_user: user` + `subscribe(params)` + check `subscription.confirmed?` / `subscription.rejected?` + `transmissions.last` for transmitted data
  - `Project#users` association checks membership efficiently — use `.include?(current_user)` for membership verification in channels
---
