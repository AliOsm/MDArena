upstream rails_app {
  server host.docker.internal:3001;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 50m;

  # Git Smart HTTP
  location ~ ^/git/(?<slug>[^/]+)\.git(?<git_path>/.*)$ {
    auth_request /internal/git/authorize;
    auth_request_set $repo_uuid $upstream_http_x_repo_uuid;

    add_header WWW-Authenticate 'Basic realm="Git"' always;

    client_max_body_size 50m;

    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend;
    fastcgi_param GIT_PROJECT_ROOT /var/repos;
    fastcgi_param GIT_HTTP_EXPORT_ALL "";
    fastcgi_param PATH_INFO /$repo_uuid.git$git_path;
    fastcgi_param REMOTE_USER $remote_user;
    fastcgi_pass unix:/var/run/fcgiwrap.socket;
  }

  # Internal auth subrequest for Git
  location = /internal/git/authorize {
    internal;

    proxy_pass http://rails_app/api/git/authorize;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header Authorization $http_authorization;
  }

  # Action Cable WebSocket
  location /cable {
    proxy_pass http://rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Rails application
  location / {
    proxy_pass http://rails_app;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
