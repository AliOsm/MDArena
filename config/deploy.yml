service: mdforge

image: ghcr.io/mdforge/mdforge

servers:
  web:
    hosts:
      - 192.168.0.1
    options:
      memory: 2g
    volumes:
      - /var/repos:/var/repos

  job:
    hosts:
      - 192.168.0.1
    cmd: bundle exec good_job start
    options:
      memory: 1g
    volumes:
      - /var/repos:/var/repos

proxy:
  ssl: true
  host: app.example.com
  app_port: 3000

registry:
  server: ghcr.io

builder:
  arch: amd64

env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: 1
    GOOD_JOB_EXECUTION_MODE: external
    GIT_REPOS_ROOT: /var/repos
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - CABLE_DATABASE_URL
    - CACHE_DATABASE_URL
    - QUEUE_DATABASE_URL

accessories:
  postgres:
    image: postgres:18-alpine
    host: 192.168.0.1
    port: "127.0.0.1:5432:5432"
    env:
      secret:
        - POSTGRES_PASSWORD
    directories:
      - pgdata:/var/lib/postgresql/data

  nginx:
    image: nginx:alpine
    host: 192.168.0.1
    port: "443:443"
    volumes:
      - /var/repos:/var/repos:ro
      - /etc/ssl:/etc/ssl:ro
    files:
      - config/nginx/app.conf:/etc/nginx/conf.d/default.conf

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

asset_path: /rails/public/assets
